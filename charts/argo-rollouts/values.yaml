# -- Install and upgrade CRDs
installCRDs: true
# -- Keep CRD's on helm uninstall
keepCRDs: true

# -- `false` runs controller in namespaced mode (does not require cluster RBAC)
clusterInstall: true

# -- String to partially override "argo-rollouts.fullname" template
nameOverride:

# -- String to fully override "argo-rollouts.fullname" template
fullnameOverride:

## Override APIVersions
## If you want to template helm charts but cannot access k8s API server
## you can set api versions here
apiVersionOverrides:
  # -- String to override apiVersion of ingresses rendered by this helm chart
  ingress: "" # networking.k8s.io/v1beta1

# -- Override the Kubernetes version, which is used to evaluate certain manifests
kubeVersionOverride: ""

controller:
  notifications:
    enabled: false
    slackToken: "$slack-token"
    templates:
      rolloutCompleted: |
        message: Rollout Completed.
        slack:
          attachments: |
              [{
                "title": "Argo UI",
                "title_link": "https://argo.prd.gaff.systems/rollout/{{.rollout.metadata.name}}",
                "color": "#18be52",
                "fields": [
                {
                  "title": "Service",
                  "value": "{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}}",
                  "short": true
                },
                {
                  "title": "Strategy",
                  "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
                  "short": true
                }
                {{range $index, $c := .rollout.spec.strategy.canary.analysis.templates}}
                  {{if not $index}},{{end}}
                  {{if $index}},{{end}}
                  {
                    "title": "Analysis Template",
                    "value": "{{$c.templateName}}",
                    "short": true
                  }
                {{end}}
                ]
              }]
      rolloutUpdated: |
        message: Rollout Started.
        slack:
          attachments: |
              [{
                "title": "Argo UI",
                "title_link": "https://argo.prd.gaff.systems/rollout/{{.rollout.metadata.name}}",
                "color": "#18be52",
                "fields": [
                {
                  "title": "Service",
                  "value": "{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}}",
                  "short": true
                },
                {
                  "title": "Strategy",
                  "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
                  "short": true
                }
                {{range $index, $c := .rollout.spec.strategy.canary.analysis.templates}}
                  {{if not $index}},{{end}}
                  {{if $index}},{{end}}
                  {
                    "title": "Analysis Template",
                    "value": "{{$c.templateName}}",
                    "short": true
                  }
                {{end}}
                {{range $index, $stepMap := .rollout.spec.strategy.canary.steps}}
                  {{range $stepName, $stepValue := $stepMap}}
                    {{if not (eq $stepName "setCanaryScale") }}
                    {{if not $index}},{{end}}
                    {{if $index}},{{end}}
                      {
                        "title": "Step {{ add $index 1}}",
                        {{if eq $stepName "pause" }}
                        {{range $pauseName, $pauseValue := $stepValue}}
                        "value": "{{$stepName}}: {{$pauseValue}}",
                        {{end}}
                        {{else}}
                        "value": "{{$stepName}}: {{$stepValue}}",
                        {{end}}
                        "short": true
                      }
                   {{end}}
                  {{end}}
                {{end}}
                ]
              }]
      rolloutAborted: |
        message: Rollout Aborted.
        slack:
          attachments: |
              [{
                "title": "Argo UI",
                "title_link": "https://argo.prd.gaff.systems/rollout/{{.rollout.metadata.name}}",
                "color": "#d61317",
                "fields": [
                {
                  "title": "Service",
                  "value": "{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}}",
                  "short": true
                },
                {
                  "title": "Strategy",
                  "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
                  "short": true
                }
                ]
              }]
      analysisRunError: |
        message: Rollout Failed, analysis run in error state.
        slack:
          attachments: |
              [{
                "title": "Argo UI",
                "title_link": "https://argo.prd.gaff.systems/rollout/{{.rollout.metadata.name}}",
                "color": "#ECB22E",
                "fields": [
                {
                  "title": "Service",
                  "value": "{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}}",
                  "short": true
                },
                {
                  "title": "Strategy",
                  "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
                  "short": true
                }
                {{range $index, $c := .rollout.spec.strategy.canary.analysis.templates}}
                  {{if not $index}},{{end}}
                  {{if $index}},{{end}}
                  {
                    "title": "Analysis Template",
                    "value": "{{$c.templateName}}",
                    "short": true
                  }
                {{end}}
                ]
              }]
      analysisRunFailed: |
        message: Rollout Failed, analysis run failed.
        slack:
          attachments: |
              [{
                "title": "Argo UI",
                "title_link": "https://argo.prd.gaff.systems/rollout/{{.rollout.metadata.name}}",
                "color": "#E01E5A",
                "fields": [
                {
                  "title": "Service",
                  "value": "{{.rollout.metadata.namespace}}/{{.rollout.metadata.name}}",
                  "short": true
                },
                {
                  "title": "Strategy",
                  "value": "{{if .rollout.spec.strategy.blueGreen}}BlueGreen{{end}}{{if .rollout.spec.strategy.canary}}Canary{{end}}",
                  "short": true
                }
                {{range $index, $c := .rollout.spec.strategy.canary.analysis.templates}}
                  {{if not $index}},{{end}}
                  {{if $index}},{{end}}
                  {
                    "title": "Analysis Template",
                    "value": "{{$c.templateName}}",
                    "short": true
                  }
                {{end}}
                ]
              }]
      triggerOnRolloutCompleted: |
        - send: [rollout-completed]
      triggerOnRolloutUpdated: |
        - send: [rollout-updated]
      triggerOnRolloutAborted: |
        - send: [rollout-aborted]
      triggerOnAnalysisRunError: |
        - send: [analysis-run-error]
      triggerOnAnalysisRunFailed: |
        - send: [analysis-run-failed]

  # -- Value of label `app.kubernetes.io/component`
  component: rollouts-controller
  # -- [Node selector]
  nodeSelector: {}
  # -- [Tolerations] for use with node taints
  tolerations: []
  # -- Assign custom [affinity] rules to the deployment
  affinity: {}
  # -- The number of controller pods to run
  replicas: 1
  image:
    # -- Registry to use
    registry: quay.io
    # -- Repository to use
    repository: argoproj/argo-rollouts
    # -- Overrides the image tag (default is the chart appVersion)
    tag: ""
    # -- Image pull policy
    pullPolicy: IfNotPresent

  # -- Additional command line arguments to pass to rollouts-controller.  A list of flags.
  extraArgs: []

  # -- Literal yaml for extra containers to be added to controller deployment.
  ## Additional containers to add to the rollouts controller deployment
  ## This will be rendered as the literal yaml
  extraContainers: []

  # -- Resource limits and requests for the controller pods.
  resources: {}
  #  limits:
  #    cpu: 100m
  #    memory: 128Mi
  #  requests:
  #    cpu: 50m
  #    memory: 64Mi

  metrics:
    # -- Deploy metrics service
    enabled: false
    serviceMonitor:
      # -- Enable a prometheus ServiceMonitor
      enabled: false
      # -- Labels to be added to the ServiceMonitor
      additionalLabels: {}
      # -- Annotations to be added to the ServiceMonitor
      additionalAnnotations: {}

  # -- Configure liveness [probe] for the controller
  # @default -- See [values.yaml]
  livenessProbe:
    httpGet:
      path: /metrics
      port: 8090
    initialDelaySeconds: 30
    periodSeconds: 20
    failureThreshold: 3
    successThreshold: 1
    timeoutSeconds: 10

  # -- Configure readiness [probe] for the controller
  # @default -- See [values.yaml]
  readinessProbe:
    httpGet:
      path: /metrics
      port: 8090
    initialDelaySeconds: 15
    periodSeconds: 5
    failureThreshold: 3
    successThreshold: 1
    timeoutSeconds: 4

serviceAccount:
  # -- Specifies whether a service account should be created
  create: true
  # -- Annotations to add to the service account
  annotations: {}
  # -- The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

# -- Annotations to be added to all CRDs
crdAnnotations: {}

# -- Annotations to be added to the Rollout pods
podAnnotations: {}

# -- Security Context to set on pod level
podSecurityContext:
  runAsNonRoot: true

# -- Security Context to set on container level
containerSecurityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

# -- Annotations to be added to the Rollout service
serviceAnnotations: {}

# -- Labels to be added to the Rollout pods
podLabels: {}

# -- Secrets with credentials to pull images from a private registry. Registry secret names as an array.
imagePullSecrets: []
# - name: argo-pull-secret

dashboard:
  # -- Deploy dashboard server
  enabled: false
  # -- Value of label `app.kubernetes.io/component`
  component: rollouts-dashboard
  # -- [Node selector]
  nodeSelector: {}
  # -- [Tolerations] for use with node taints
  tolerations: []
  # -- Assign custom [affinity] rules to the deployment
  affinity: {}
  image:
    # -- Registry to use
    registry: quay.io
    # --  Repository to use
    repository: argoproj/kubectl-argo-rollouts
    # -- Overrides the image tag (default is the chart appVersion)
    tag: ""
    # -- Image pull policy
    pullPolicy: IfNotPresent
  # -- Additional command line arguments to pass to rollouts-dashboard. A list of flags.
  extraArgs: []
  # -- Resource limits and requests for the dashboard pods.
  resources: {}
  # -- Security Context to set on pod level
  podSecurityContext:
    runAsNonRoot: true
  # -- Security Context to set on container level
  containerSecurityContext: {}
  service:
    # -- Sets the type of the Service
    type: ClusterIP
    # -- LoadBalancer will get created with the IP specified in this field
    loadBalancerIP: ""
    # -- Source IP ranges to allow access to service from
    loadBalancerSourceRanges: []
    # -- Dashboard service external IPs
    externalIPs: []
    # -- Service annotations
    annotations: {}
    # -- Service labels
    labels: {}
    # -- Service port name
    portName: dashboard
    # -- Service port
    port: 3100
    # -- Service target port
    targetPort: 3100
  serviceAccount:
    # -- Specifies whether a dashboard service account should be created
    create: true
    # -- Annotations to add to the dashboard service account
    annotations: {}
    # -- The name of the service account to use.
    # If not set and create is true, a name is generated using the fullname template
    name: ""

  ## Ingress configuration.
  ## ref: https://kubernetes.io/docs/user-guide/ingress/
  ##
  ingress:
    # -- Enable dashboard ingress support
    enabled: false
    # -- Dashboard ingress annotations
    annotations: {}
    # -- Dashboard ingress labels
    labels: {}
    # -- Dashboard ingress class name
    ingressClassName: ""

    # -- Dashboard ingress hosts
    ## Argo Rollouts Dashboard Ingress.
    ## Hostnames must be provided if Ingress is enabled.
    ## Secrets must be manually created in the namespace
    hosts: []
      # - argorollouts.example.com

    # -- Dashboard ingress paths
    paths:
      - /
    # -- Dashboard ingress path type
    pathType: Prefix
    # -- Dashboard ingress extra paths
    extraPaths: []
      # - path: /*
      #   backend:
      #     serviceName: ssl-redirect
      #     servicePort: use-annotation
      ## for Kubernetes >=1.19 (when "networking.k8s.io/v1" is used)
      # - path: /*
      #   pathType: Prefix
      #   backend:
      #     service
      #       name: ssl-redirect
      #       port:
      #         name: use-annotation

    # -- Dashboard ingress tls
    tls: []
      # - secretName: argorollouts-example-tls
      #   hosts:
      #     - argorollouts.example.com

cluster_analysis_template: no
